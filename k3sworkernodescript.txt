#!/bin/bash

# Update the system
sudo apt-get update && sudo apt-get upgrade -y

# Install Docker
echo "Installing Docker..."
sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
sudo apt-get update && sudo apt-get install -y docker-ce

# Replace <controller-ip> with the IP address of your controller node
# Replace <token> with the token from your controller node
CONTROLLER_IP=<controller-ip>
TOKEN=<token>

# Install k3s agent and join the cluster
echo "Installing k3s agent..."
sudo curl -sfL https://get.k3s.io | K3S_URL=https://${CONTROLLER_IP}:6443 K3S_TOKEN=${TOKEN} sh -

# Verify the worker node is connected
sudo k3s kubectl get nodes

# Ensure firewall rules allow traffic to NodePort services
# (Adjust the port range as needed)
sudo ufw allow 30000:32767/tcp

echo "Worker node installation complete."